{"data":{"site":{"siteMetadata":{"title":"Kaier33","author":"KaierChou"}},"markdownRemark":{"id":"1560fcf5-23bf-5a20-80ad-082bf6e1a3dc","html":"<h1 id=\"centos-7-ä½¿ç”¨-acmesh-è‡ªåŠ¨ç”³è¯·å…è´¹-ssl-è¯ä¹¦\"><a href=\"#centos-7-%E4%BD%BF%E7%94%A8-acmesh-%E8%87%AA%E5%8A%A8%E7%94%B3%E8%AF%B7%E5%85%8D%E8%B4%B9-ssl-%E8%AF%81%E4%B9%A6\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CentOS 7 ä½¿ç”¨ acme.sh è‡ªåŠ¨ç”³è¯·å…è´¹ SSL è¯ä¹¦</h1>\n<p><strong>å®‰è£…</strong></p>\n<ol>\n<li><code class=\"language-text\">curl https://get.acme.sh | sh</code> ç”¨äºå®‰è£… acme.sh</li>\n<li>å®‰è£…å®Œæ¯•ä¹‹å, é€€å‡ºç™»å½•ï¼Œå†é‡æ–°ç™»å½•ï¼Œæˆ–è€…æ‰§è¡Œä¸€ä¸‹ <code class=\"language-text\">source ~/.bashrc</code>ã€€</li>\n<li>\n<p><code class=\"language-text\">acme.sh -v</code> å¯æŸ¥çœ‹ç‰ˆæœ¬å·</p>\n<hr>\n<p><strong>ç”³è¯·è¯ä¹¦</strong></p>\n</li>\n</ol>\n<p><a href=\"https://github.com/Neilpang/acme.sh/blob/master/dnsapi/README.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">How to use DNS API</a>  æ‰¾åˆ°è‡ªå·±çš„ DNS æœåŠ¡å•†å¯¹åº”çš„å‘½ä»¤ï¼Œå¦‚é˜¿é‡Œäº‘çš„:  </p>\n<p>The Ali<em>Key and Ali</em>Secret will be saved in <code class=\"language-text\">~/.acme.sh/account.conf</code> and will be reused when needed.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># æ¢æˆè‡ªå·±çš„ AccessKeyID ID å’Œ AccessKeySecret\nexport Ali_Key=&quot;your Ali_Key&quot;\nexport Ali_Secret=&quot;your Ali_Secret&quot;</code></pre></div>\n<p>ç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># æ¢æˆè‡ªå·±çš„åŸŸåï¼Œå¤šä¸ªåŸŸåæ·»åŠ å¤šä¸ª &quot;-d &lt;doman&gt;&quot;ï¼Œæ”¯æŒæ³›åŸŸå\nacme.sh --issue --dns dns_ali -d kaier33.top -d *.kaier33.top</code></pre></div>\n<ul>\n<li>é˜¿é‡Œäº‘æ¨èä½¿ç”¨ <a href=\"https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fram.console.aliyun.com%2F#/user/list\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">å­ç”¨æˆ·AccessKey</a>ï¼Œç„¶ååªç»™äºˆå­ç”¨æˆ· â€œAliyunDNSFullAccessâ€œ æƒé™ã€‚</li>\n<li>é˜¿é‡Œäº‘ç”¨æˆ·å®‰å…¨ç»„éœ€è¦å¯ç”¨ 443 ç«¯å£</li>\n</ul>\n<hr>\n<p><strong>ä¿å­˜è¯ä¹¦</strong>    </p>\n<ol>\n<li>\n<p>åˆ›å»ºä¿å­˜è¯ä¹¦çš„ç›®å½•ï¼š  </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># æ¢æˆè‡ªå·±çš„ç›®å½•åç§°\nmkdir -p /etc/nginx/ssl</code></pre></div>\n</li>\n<li>\n<p>ä¿å­˜è¯ä¹¦å¹¶é‡å¯ nginxï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># æ¢æˆè‡ªå·±çš„åŸŸå\nacme.sh --install-cert -d kaier33.top \\\n--key-file        /etc/nginx/ssl/kaier33.top.key \\\n--fullchain-file  /etc/nginx/ssl/fullchain.cer \\\n--reloadcmd      &quot;sudo nginx -s reload&quot;</code></pre></div>\n</li>\n</ol>\n<hr>\n<p><strong>è‡ªåŠ¨æ›´æ–° acme.sh</strong>  </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">acme.sh --upgrade --auto-upgrade</code></pre></div>\n<hr>\n<p><strong>nginx é…ç½®</strong>  </p>\n<ol>\n<li>\n<p>ç”Ÿæˆ DH å¯†é’¥å‚æ•°</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># æ¢æˆè‡ªå·±ä¿å­˜è¯ä¹¦çš„è·¯å¾„\nopenssl dhparam 2048 -out /etc/nginx/ssl/dhparam.pem</code></pre></div>\n</li>\n<li>\n<p>SSL é…ç½® <code class=\"language-text\">vim /etc/nginx/conf.d/ssl.conf</code><br>\nåœ¨ <code class=\"language-text\">/etc/nginx/conf.d/</code> ç›®å½•ä¸‹åˆ›å»º SSL é…ç½®æ–‡ä»¶ï¼š </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># certs sent to the client in SERVER HELLO are concatenated in ssl_certificate\nssl_certificate /etc/nginx/ssl/fullchain.cer;\nssl_certificate_key /etc/nginx/ssl/kaier33.top.key;\nssl_session_timeout 1d;\nssl_session_cache shared:SSL:50m;\nssl_session_tickets off;</code></pre></div>\n</li>\n</ol>\n<h1 id=\"diffie-hellman-parameter-for-dhe-ciphersuites-recommended-2048-bits\"><a href=\"#diffie-hellman-parameter-for-dhe-ciphersuites-recommended-2048-bits\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Diffie-Hellman parameter for DHE ciphersuites, recommended 2048 bits</h1>\n<p>ssl_dhparam /etc/nginx/ssl/dhparam.pem;</p>\n<h1 id=\"intermediate-configuration-tweak-to-your-needs\"><a href=\"#intermediate-configuration-tweak-to-your-needs\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>intermediate configuration. tweak to your needs.</h1>\n<p>ssl<em>protocols TLSv1 TLSv1.1 TLSv1.2;\nssl</em>ciphers â€˜ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSSâ€™;\nssl<em>ecdh</em>curve secp384r1;\nssl<em>prefer</em>server_ciphers on;</p>\n<h1 id=\"fetch-ocsp-records-from-url-in-ssl_certificate-and-cache-them\"><a href=\"#fetch-ocsp-records-from-url-in-ssl_certificate-and-cache-them\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fetch OCSP records from URL in ssl_certificate and cache them</h1>\n<p>ssl<em>stapling on;\nssl</em>stapling<em>verify on;\nresolver 223.5.5.5 223.6.6.6 114.114.114.114 8.8.8.8 8.8.4.4 valid=300s;\nresolver</em>timeout 10s;</p>\n<h1 id=\"hsts-ngxhttpheaders_module-is-required-31536000-seconds-â‰ˆ-1-year\"><a href=\"#hsts-ngxhttpheaders_module-is-required-31536000-seconds-%E2%89%88-1-year\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>HSTS (ngx<em>http</em>headers_module is required) (31536000 seconds â‰ˆ 1 year)</h1>\n<p>add_header Strict-Transport-Security â€˜max-age=31536000; includeSubdomains; preloadâ€™;</p>\n<h1 id=\"only-allow-frames-form-same-origin\"><a href=\"#only-allow-frames-form-same-origin\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>only allow frames form same origin</h1>\n<p>add_header X-Frame-Options SAMEORIGIN;</p>\n<h1 id=\"no-mime-sniffing-for-content-type\"><a href=\"#no-mime-sniffing-for-content-type\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>no MIME-sniffing for Content-Type</h1>\n<p>add_header X-Content-Type-Options nosniff;</p>\n<h1 id=\"hide-nginx-version\"><a href=\"#hide-nginx-version\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>hide nginx version</h1>\n<p>server_tokens off;</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">+ `ssl_certificate` ï¼Œ`ssl_certificate_key` ï¼Œ `ssl_dhparam` æ¢æˆè‡ªå·±æ–‡ä»¶çš„è·¯å¾„ã€‚\n+ è¿™ç§å•ç‹¬çš„é…ç½®æ–‡ä»¶å°†ç›´æ¥è¢« `nginx.conf` åŠ è½½ï¼Œåœ¨ http åŸŸä¸‹ç”Ÿæ•ˆï¼Œæ‰€æœ‰ server éƒ½å…±äº«ç›¸åŒçš„ SSL é…ç½®ã€‚å¦‚æœæƒ³æ¯ä¸ª server å•ç‹¬é…ç½®ï¼Œåˆ™æ·»åŠ é…ç½®ä»£ç åˆ°å¯¹åº”çš„ server åŸŸä¸‹é¢ã€‚  \n\n***\n\n**Serveré…ç½®**  \n\nåœ¨ `/etc/nginx/conf.d/` ç›®å½•ä¸‹åˆ›å»ºç½‘ç«™çš„é…ç½®æ–‡ä»¶ï¼š</code></pre></div>\n<p>vim /etc/nginx/conf.d/kaier33.top.conf</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"></code></pre></div>\n<h1 id=\"è¿™é‡ŒæŒ‡å‘çš„æ˜¯ä¸€ä¸ªnginxé™æ€ç½‘é¡µè§†è‡ªèº«æƒ…å†µåšæ›´æ”¹\"><a href=\"#%E8%BF%99%E9%87%8C%E6%8C%87%E5%90%91%E7%9A%84%E6%98%AF%E4%B8%80%E4%B8%AAnginx%E9%9D%99%E6%80%81%E7%BD%91%E9%A1%B5%E8%A7%86%E8%87%AA%E8%BA%AB%E6%83%85%E5%86%B5%E5%81%9A%E6%9B%B4%E6%94%B9\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ã€€è¿™é‡ŒæŒ‡å‘çš„æ˜¯ä¸€ä¸ªnginxé™æ€ç½‘é¡µ,è§†è‡ªèº«æƒ…å†µåšæ›´æ”¹</h1>\n<p>server {\nlisten 80;\nserver<em>name kaier33.top;\nreturn 301 <a href=\"https://$http\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://$http</a></em>host$request_uri;\n}</p>\n<h1 id=\"https-for-kaier33top\"><a href=\"#https-for-kaier33top\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>https for kaier33.top</h1>\n<p>server {\nlisten 443;\nssl on;\nserver<em>name kaier33.top;\nroot /home/kaier33/blog</em>manage/client;\nindex index.html;\n}</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">```vim /etc/nginx/nginx.conf``` æŠŠé‡Œé¢çš„serve ä¸éœ€è¦ç”¨çš„æ³¨é‡Šæ‰  \nç„¶åé‡å¯nginx  ```sudo nginx -s reload```   \n\n***\n\n**SSL å®‰å…¨æ£€æµ‹**  \n\næ£€æµ‹åœ°å€ï¼šhttps://www.ssllabs.com/ssltest/    \n\nè¾“å…¥åŸŸåï¼Œæ­£å¸¸æƒ…å†µä¸‹æ£€æµ‹ç»“æœåº”ä¸º A+ ã€‚\n\n![result](./ssl.png)\n\nç„¶åå°±é˜”ä»¥æ„‰å¿«çš„ç©è€å•¦~ \n\n&lt;!-- [end](/thanks watch/) --&gt;</code></pre></div>","timeToRead":4,"frontmatter":{"title":"è®°ä¸€æ¬¡httpå‡çº§https","date":"September 12, 2019","spoiler":"acme.shå¯è®©å…¨ç«™ç‚¹éƒ½æ”¯æŒHTTPS ğŸ‰"},"fields":{"slug":"/è®°ä¸€æ¬¡httpå‡çº§https/","langKey":"en"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/è®°ä¸€æ¬¡httpå‡çº§https/","previous":null,"next":null,"translations":[],"translatedLinks":[]}}