{"data":{"site":{"siteMetadata":{"title":"Kaier33","author":"KaierChou"}},"markdownRemark":{"id":"1560fcf5-23bf-5a20-80ad-082bf6e1a3dc","html":"<h2 id=\"centos-7-使用-acmesh-自动申请免费-ssl-证书\"><a href=\"#centos-7-%E4%BD%BF%E7%94%A8-acmesh-%E8%87%AA%E5%8A%A8%E7%94%B3%E8%AF%B7%E5%85%8D%E8%B4%B9-ssl-%E8%AF%81%E4%B9%A6\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CentOS 7 使用 acme.sh 自动申请免费 SSL 证书</h2>\n<h3 id=\"安装\"><a href=\"#%E5%AE%89%E8%A3%85\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>安装</h3>\n<ol>\n<li><code class=\"language-text\">curl https://get.acme.sh | sh</code> 用于安装 acme.sh</li>\n<li>安装完毕之后, 退出登录，再重新登录，或者执行一下 <code class=\"language-text\">source ~/.bashrc</code>　</li>\n<li>\n<p><code class=\"language-text\">acme.sh -v</code> 可查看版本号</p>\n<hr>\n</li>\n</ol>\n<h3 id=\"申请证书\"><a href=\"#%E7%94%B3%E8%AF%B7%E8%AF%81%E4%B9%A6\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>申请证书</h3>\n<p><a href=\"https://github.com/Neilpang/acme.sh/blob/master/dnsapi/README.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">How to use DNS API</a>  找到自己的 DNS 服务商对应的命令，如阿里云的:  </p>\n<p>The Ali<em>Key and Ali</em>Secret will be saved in <code class=\"language-text\">~/.acme.sh/account.conf</code> and will be reused when needed.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 换成自己的 AccessKeyID ID 和 AccessKeySecret\nexport Ali_Key=&quot;your Ali_Key&quot;\nexport Ali_Secret=&quot;your Ali_Secret&quot;</code></pre></div>\n<p>然后执行以下命令</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 换成自己的域名，多个域名添加多个 &quot;-d &lt;doman&gt;&quot;，支持泛域名\nacme.sh --issue --dns dns_ali -d kaier33.top -d *.kaier33.top</code></pre></div>\n<ul>\n<li>阿里云推荐使用 <a href=\"https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fram.console.aliyun.com%2F#/user/list\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">子用户AccessKey</a>，然后只给予子用户 “AliyunDNSFullAccess“ 权限。</li>\n<li>阿里云用户安全组需要启用 443 端口</li>\n</ul>\n<hr>\n<h3 id=\"保存证书\"><a href=\"#%E4%BF%9D%E5%AD%98%E8%AF%81%E4%B9%A6\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>保存证书</h3>\n<ol>\n<li>\n<p>创建保存证书的目录：  </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 换成自己的目录名称\nmkdir -p /etc/nginx/ssl</code></pre></div>\n</li>\n<li>\n<p>保存证书并重启 nginx：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 换成自己的域名\nacme.sh --install-cert -d kaier33.top \\\n--key-file        /etc/nginx/ssl/kaier33.top.key \\\n--fullchain-file  /etc/nginx/ssl/fullchain.cer \\\n--reloadcmd      &quot;sudo nginx -s reload&quot;</code></pre></div>\n</li>\n</ol>\n<hr>\n<h3 id=\"自动更新-acmesh\"><a href=\"#%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0-acmesh\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>自动更新 acme.sh</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">acme.sh --upgrade --auto-upgrade</code></pre></div>\n<hr>\n<h3 id=\"nginx-配置\"><a href=\"#nginx-%E9%85%8D%E7%BD%AE\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>nginx 配置</h3>\n<ol>\n<li>\n<p>生成 DH 密钥参数</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 换成自己保存证书的路径\nopenssl dhparam 2048 -out /etc/nginx/ssl/dhparam.pem</code></pre></div>\n</li>\n<li>SSL 配置 <code class=\"language-text\">vim /etc/nginx/conf.d/ssl.conf</code><br>\n在 <code class=\"language-text\">/etc/nginx/conf.d/</code> 目录下创建 SSL 配置文件：  </li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># certs sent to the client in SERVER HELLO are concatenated in ssl_certificate\nssl_certificate /etc/nginx/ssl/fullchain.cer;\nssl_certificate_key /etc/nginx/ssl/kaier33.top.key;\nssl_session_timeout 1d;\nssl_session_cache shared:SSL:50m;\nssl_session_tickets off;\n\n# Diffie-Hellman parameter for DHE ciphersuites, recommended 2048 bits\nssl_dhparam /etc/nginx/ssl/dhparam.pem;\n\n# intermediate configuration. tweak to your needs.\nssl_protocols TLSv1 TLSv1.1 TLSv1.2;\nssl_ciphers &#39;ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS&#39;;\nssl_ecdh_curve secp384r1;\nssl_prefer_server_ciphers on;\n\n# fetch OCSP records from URL in ssl_certificate and cache them\nssl_stapling on;\nssl_stapling_verify on;\nresolver 223.5.5.5 223.6.6.6 114.114.114.114 8.8.8.8 8.8.4.4 valid=300s;\nresolver_timeout 10s;\n\n# HSTS (ngx_http_headers_module is required) (31536000 seconds ≈ 1 year)\nadd_header Strict-Transport-Security &#39;max-age=31536000; includeSubdomains; preload&#39;;\n\n# only allow frames form same origin\nadd_header X-Frame-Options SAMEORIGIN;\n\n# no MIME-sniffing for Content-Type\nadd_header X-Content-Type-Options nosniff;\n\n# hide nginx version\nserver_tokens off;</code></pre></div>\n<ul>\n<li><code class=\"language-text\">ssl_certificate</code> ，<code class=\"language-text\">ssl_certificate_key</code> ， <code class=\"language-text\">ssl_dhparam</code> 换成自己文件的路径。</li>\n<li>这种单独的配置文件将直接被 <code class=\"language-text\">nginx.conf</code> 加载，在 http 域下生效，所有 server 都共享相同的 SSL 配置。如果想每个 server 单独配置，则添加配置代码到对应的 server 域下面。  </li>\n</ul>\n<hr>\n<h3 id=\"server配置\"><a href=\"#server%E9%85%8D%E7%BD%AE\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Server配置</h3>\n<p>在 <code class=\"language-text\">/etc/nginx/conf.d/</code> 目录下创建网站的配置文件：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">vim /etc/nginx/conf.d/kaier33.top.conf</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">#　这里指向的是一个nginx静态网页,视自身情况做更改\nserver {\n  listen 80;\n  server_name kaier33.top;\n  return 301 https://$http_host$request_uri;\n}\n\n# https for kaier33.top\nserver {\n  listen 443;\n  ssl on;\n  server_name kaier33.top;\n  root /home/kaier33/blog_manage/client;\n  index index.html;\n}</code></pre></div>\n<p><code class=\"language-text\">vim /etc/nginx/nginx.conf</code> 把里面的serve 不需要用的注释掉<br>\n然后重启nginx  <code class=\"language-text\">sudo nginx -s reload</code>   </p>\n<hr>\n<h3 id=\"ssl-安全检测\"><a href=\"#ssl-%E5%AE%89%E5%85%A8%E6%A3%80%E6%B5%8B\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SSL 安全检测</h3>\n<p>检测地址：<a href=\"https://www.ssllabs.com/ssltest/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.ssllabs.com/ssltest/</a>    </p>\n<p>输入域名，正常情况下检测结果应为 A+ 。</p>\n<p><img src=\"https://i.ibb.co/L570LFj/ssl.png\" alt=\"result\"></p>\n<p>然后就阔以愉快的玩耍啦~</p>\n<!-- [end](/thanks watch/) -->","timeToRead":4,"frontmatter":{"title":"记一次http升级https","date":"September 12, 2019","spoiler":"acme.sh可让全站点都支持HTTPS 🎉"},"fields":{"slug":"/记一次http升级https/","langKey":"en"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/记一次http升级https/","previous":null,"next":null,"translations":[],"translatedLinks":[]}}