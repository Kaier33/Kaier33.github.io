{"version":3,"sources":["../../../src/db/common/query.js"],"names":["_","require","getNamedType","getQueryFields","filter","sort","group","distinct","filterFields","dropQueryOperators","sortFields","fields","merge","map","pathToObject","mergeObjects","obj1","obj2","Object","keys","reduce","acc","key","value","objects","Boolean","first","rest","obj","path","split","reduceRight","k","v","isPlainObject","hasFieldResolvers","type","getFields","some","fieldName","filterValue","field","resolve","module","exports"],"mappings":"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","sourcesContent":["const _ = require(`lodash`)\nconst { getNamedType } = require(`graphql`)\n\nconst getQueryFields = ({ filter, sort, group, distinct }) => {\n  const filterFields = filter ? dropQueryOperators(filter) : {}\n  const sortFields = (sort && sort.fields) || []\n  return merge(\n    filterFields,\n    ...sortFields.map(pathToObject),\n    pathToObject(group),\n    pathToObject(distinct)\n  )\n}\n\nconst mergeObjects = (obj1, obj2) =>\n  Object.keys(obj2).reduce((acc, key) => {\n    const value = obj2[key]\n    if (typeof value === `object` && value && acc[key]) {\n      acc[key] = mergeObjects(acc[key], value)\n    } else {\n      acc[key] = value\n    }\n    return acc\n  }, obj1)\n\nconst merge = (...objects) => {\n  const [first, ...rest] = objects.filter(Boolean)\n  return rest.reduce((acc, obj) => mergeObjects(acc, obj), { ...first })\n}\n\nconst pathToObject = path => {\n  if (path && typeof path === `string`) {\n    return path.split(`.`).reduceRight((acc, key) => {\n      return { [key]: acc }\n    }, true)\n  }\n  return {}\n}\n\nconst dropQueryOperators = filter =>\n  Object.keys(filter).reduce((acc, key) => {\n    const value = filter[key]\n    const k = Object.keys(value)[0]\n    const v = value[k]\n    if (_.isPlainObject(value) && _.isPlainObject(v)) {\n      acc[key] =\n        k === `elemMatch` ? dropQueryOperators(v) : dropQueryOperators(value)\n    } else {\n      acc[key] = true\n    }\n    return acc\n  }, {})\n\nconst hasFieldResolvers = (type, filterFields) => {\n  const fields = type.getFields()\n  return Object.keys(filterFields).some(fieldName => {\n    const filterValue = filterFields[fieldName]\n    const field = fields[fieldName]\n    return (\n      Boolean(field.resolve) ||\n      (filterValue !== true &&\n        hasFieldResolvers(getNamedType(field.type), filterValue))\n    )\n  })\n}\n\nmodule.exports = {\n  dropQueryOperators,\n  getQueryFields,\n  hasFieldResolvers,\n}\n"],"file":"query.js"}